# NetworksLab2021
# Описание протокола

Заголовок в 8 бит

- В сообщении от клиента к серверу передается сначала длина сообщения а затем и сообщение как временная зона, имя и сообщение в формате 
<tz>name->message либо клучевое слово file после которого требуется ввести имя файла. tz представленна строкой, например 
'Europe/Moscow'. Файл передается как заголовок длины, потом имя файла и его размер а потом сам файла как поток байт.

- От сервера к клиенту даннуе пересылаются аналогично, для передачи файла принимается ключевое слово file после чего
вся переданная от пользователя информация записывается в переменные и транслируется ко всем подключенным. При передачи 
простого сообщения из принятого потока достается временная зона и время на сервере записывается в транслирующее всем 
пользователям сообщение измененным в соотствии с временной зоной пользователя.
  
- При запуске сервера на удаленном компьютере возникли проблемы с заголовками, они приходи урезанными, поэтому в сообщении в конце есть спец символы как указатель конца. Теперь, даже если заголовок пришел не полный, сообщение считается и соберется полностью

# Основные классы и функции
Классов нет
В серевере 3 функции: handle, broadcast и receive_connection.

- broadcast просто трансирует сообщение пользователям
- handle обрабатывает все полученные данные
- receive_connection принимает соединение от пользователя

# В клиенте 2 функции

В клиенте 2 функции: receive_message и send_message.

- receive_message принимает сообщение от сервера
- send_message отправляет сообщение на сервер

# Описание проблем с которыми столкнулся

Самой большой была проблема принять полностью длинное сообщение. В итоге я смог реализовать 2 варианта решения этой проблемы:
1) Это тот который реализован сейчас с использованием заголовка
2) Использование разделителей. От него я отказался так как почему-то, при использовании кодировки utf-8, utf-16 и utf-32
русский текст, который выходил за размер буфера (а он был фиксирован и равен 1024) всегда выдавал ошибку декодирования 
при приеме, соответственно если буфер вмещал сообщение полностью то и ошибки не было

Как таковой проблемы с часовыми поясами у меня не было, я достаточно быстро нашел библиотеку pytz на которую была ссылка
чуть ли не в каждом вопросе работы с tz на stackoverflow.

С файлами также проблем серьезных не возникло, так как с ними работа по большей части такая же как и с 
пересылкой больших сообщений, разве что мысль о том, что данные файла можно записать в переменную вместо того, чтобы создавать его 
на сервере, отправлять и после этого удалять с сервера это принадлежит не мне а была подсказана напрямую преподавателем.

При запуске на файла сервере на удаленном компьютере появились проблемы:
- Английский текст не передавался полностью
- Русский текст выдавал ошибку
- Файл передавался лишь частично

Причиной оказался неполноценный заголовок в котором передался размер сообщения либо файла. И в том и в другом случае заголовок приходил обрезанный, например сообщения размер которого в заголовке был чуть больше 9300 а на принимающем клиенте то же сообщение было размером в чуть больше 1100.
В итоге в программу былы добавленны спец символы в конце сообщений и если размер сообщения передается некоректно сообщение все равно прийдет полностью как внизу и продемонстрированно.

Добавлены обязательные исправления, избавился от дубликатор. Получилось обойтись без введения дополнительных функций, просто немного переписал принимающие части сервера и клиента, теперь вне зависимости от того сразу ли сообщение пришло полностью или частично оно проходит на условие в цикле. Если сообщение изначально полное, то цикл минуется и сообщение обратывается, если же не полное, то перед обработкой оно пройдет цикл.

Модернизация спец символов пока не очень успешна. Если будет прогресс я обновлю репозиторий
  
![о](https://user-images.githubusercontent.com/43119772/138032460-3ebaa06d-ece2-48a4-8617-c6440156a31d.png)
![Безымянныйе](https://user-images.githubusercontent.com/43119772/137917201-bd0efa46-2036-4c49-89cc-0ce3a8169059.png)
